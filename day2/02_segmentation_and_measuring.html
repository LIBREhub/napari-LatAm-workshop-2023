

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Segmentation &#8212; Image data science with Python and Napari @LIBREhub @LatAm Bioimaging @Napari 2023</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'day2/02_segmentation_and_measuring';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/LatAmBio_Logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/LatAmBio_Logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Image data science with Python and Napari @LatAm_Bioimaging
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../day0/pre-requirements/to_be_installed.html">Course preparation</a></li>

<li class="toctree-l1 has-children"><a class="reference internal" href="../day1/intro_day1.html">Day 1: Introduction to Python and Bio-image Analysis</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../day1/1_introduction_to_napari/00_intro_introduction_to_napari.html">Introduction to the course</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../day1/2_napari_and_jupyter_notebooks/00_intro_jupyter_notebooks.html">Jupyter notebooks and napari</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../day1/2_napari_and_jupyter_notebooks/napari-assistant.html">The Napari Assistant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../day1/2_napari_and_jupyter_notebooks/export_notebooks.html">Generating Jupyter Notebooks from the Napari Assistant</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../day1/3_python_introduction/00_intro_python_introduction.html">Introduction to Python</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/01_our_first_juptyer_notebook.html">Python code in Jupyter notebooks</a></li>

<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/03_Dont_try_this_at_home.html">Pitfalls when working with Jupyter notebooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/04_Basic_types.html">Basic types in python</a></li>


<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/05_lists_tuples.html">Lists and tuples</a></li>




<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/05a_indexing.html">Indexing and Slicing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/05d_masking.html">Masking numpy arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/06_Dictionaries_and_tables.html">Dictionaries</a></li>


<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/07_Conditions.html">Conditions</a></li>

<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/08_loops.html">Loops</a></li>

<li class="toctree-l3"><a class="reference internal" href="../day1/3_python_introduction/09_custom_functions.html">Functions</a></li>

</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="intro_day2.html">Day 2: Image Filtering, Segmentation and Feature Extraction</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="1_File_paths/readme.html">File Paths</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="1_File_paths/04_Image_file_formats.html">Image file formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_File_paths/05_Folder_structures.html">Simple Folder Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_File_paths/06_EXERCISE_Folder_structures_2.html">Advanced Folder Structures</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../day3/intro_day3.html">Day 3: Napari Plugins: Developers Showcase</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../day3/napari-superres/02_napari-superres.html">napari-superres</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/LIBREhub/Image-data-science-with-Napari-and-Python-LatAm2023" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/LIBREhub/Image-data-science-with-Napari-and-Python-LatAm2023/issues/new?title=Issue%20on%20page%20%2Fday2/02_segmentation_and_measuring.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/day2/02_segmentation_and_measuring.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Segmentation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#separating-an-image-into-one-or-more-regions-of-interest">Separating an image into one or more regions of interest.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-napari-viewer">The napari viewer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-0-play-with-the-napari-viewer">Exercise 0: play with the napari viewer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmenting-nuclei-and-measuring-cell-properties">Segmenting nuclei and measuring cell properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection">Edge detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thresholding">Thresholding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#morphological-operations">Morphological operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-improve-the-points">Exercise 1: improve the points</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mixing-manual-annotation-and-algorithms">Mixing manual annotation and algorithms</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-measurements">Making measurements</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-physical-measurements">Exercise 2: physical measurements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-displaying-regionprops-or-other-values">Exercise 3: displaying regionprops (or other values)</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s1">&#39;retina&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="segmentation">
<h1>Segmentation<a class="headerlink" href="#segmentation" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<section id="separating-an-image-into-one-or-more-regions-of-interest">
<h2>Separating an image into one or more regions of interest.<a class="headerlink" href="#separating-an-image-into-one-or-more-regions-of-interest" title="Permalink to this heading">#</a></h2>
<p>Everyone has heard or seen Photoshop or a similar graphics editor take a person from one image and place them into another.  The first step of doing this is <em>identifying where that person is in the source image</em>.</p>
<p>In popular culture, the Terminator‚Äôs vision segments humans out of the overall scene:</p>
<img src="./_static/terminator-vision.png" width="700px"/>
<p>Segmentation is a fundamental operation in scientific image analysis because we often want to measure properties of real, physical <em>objects</em> such as cells embedded in our image. As such, we want to find those objects within our image.</p>
<p>Computationally, segmentations are most often represented as images, of the same size as the original image, containing integer <em>labels</em>, with one value representing one object.</p>
<p>Here is a very simple image and segmentation, taken from <a class="reference external" href="https://scikit-image.org/docs/dev/auto_examples/segmentation/plot_watershed.html#sphx-glr-auto-examples-segmentation-plot-watershed-py">this scikit-image gallery example</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>

<span class="kn">import</span> <span class="nn">napari</span>

<span class="kn">from</span> <span class="nn">skimage.segmentation</span> <span class="kn">import</span> <span class="n">watershed</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">peak_local_max</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">label_points</span>
<span class="kn">from</span> <span class="nn">skimage.color</span> <span class="kn">import</span> <span class="n">label2rgb</span>


<span class="c1"># Generate an initial image with two overlapping circles</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">indices</span><span class="p">((</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">52</span>
<span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span>
<span class="n">mask_circle1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r1</span><span class="o">**</span><span class="mi">2</span>
<span class="n">mask_circle2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="o">**</span><span class="mi">2</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">mask_circle1</span><span class="p">,</span> <span class="n">mask_circle2</span><span class="p">)</span>

<span class="c1"># Now we want to separate the two objects in image</span>
<span class="c1"># Generate the markers as local maxima of the distance to the background</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
<span class="n">markers</span> <span class="o">=</span> <span class="n">label_points</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">watershed</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>

<span class="c1"># finally, plot the result</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label2rgb</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;labels interpreted</span><span class="se">\n</span><span class="s1">as image&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Notice that ‚Äúlabels‚Äù is just a NumPy array with integer values. We have to be careful to interpret it as labels and not as an image.</p>
</section>
<section id="the-napari-viewer">
<h2>The napari viewer<a class="headerlink" href="#the-napari-viewer" title="Permalink to this heading">#</a></h2>
<p>To look at images and associated data, <em>napari</em> provides additional functionality over matplotlib, including:</p>
<ul class="simple">
<li><p>the canvas is OpenGL, interactive, and responsive</p></li>
<li><p>the canvas has <em>layers</em>, which can be individually shown or hidden</p></li>
<li><p>the viewer is <em>n-dimensional</em>, which comes in handy when your images are more than 2D, such as MRI data or (as below) microscopy data</p></li>
</ul>
<p>Here‚Äôs how to look at the same images with napari:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
<span class="n">image_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">labels_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">labels_as_image_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;labels as image&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="exercise-0-play-with-the-napari-viewer">
<h3>Exercise 0: play with the napari viewer<a class="headerlink" href="#exercise-0-play-with-the-napari-viewer" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>zoom with scroll, pan with click and drag</p></li>
<li><p>try clicking on the üëÅÔ∏è icon on each layer in the layer list to make them invisible or visible again</p></li>
<li><p>try alt-clicking on the icon: this makes every other layer invisible</p></li>
<li><p>try changing the opacity, colormap, or interpolation on a layer</p></li>
<li><p>try turning on ‚Äúgrid mode‚Äù, from the group of buttons at the bottom-left of the viewer.</p></li>
<li><p><em>select</em> the labels layer, click on the paintbrush tool, and tweak the segmentation where the two labels meet.</p></li>
</ul>
</section>
</section>
<section id="segmenting-nuclei-and-measuring-cell-properties">
<h2>Segmenting nuclei and measuring cell properties<a class="headerlink" href="#segmenting-nuclei-and-measuring-cell-properties" title="Permalink to this heading">#</a></h2>
<p>In the rest of this notebook, we will segment cell nuclei from a small sample image provided by the Allen Institute for Cell Science.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">data</span>

<span class="n">cells3d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cells3d</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cells3d</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># zcyx</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cells3d</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cells3d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The pixel spacing in this dataset is 0.29¬µm in the z (leading!) axis, and 0.26¬µm in the x and y axes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can view the 3D image using napari.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span><span class="p">,</span> <span class="p">(</span><span class="n">membrane_layer</span><span class="p">,</span> <span class="n">nuclei_layer</span><span class="p">)</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">cells3d</span><span class="p">,</span>
    <span class="n">channel_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># remember, Python uses 0-based indexing!</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;membranes&#39;</span><span class="p">,</span> <span class="s1">&#39;nuclei&#39;</span><span class="p">],</span>
    <span class="n">ndisplay</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">napari.utils.notebook_display</span> <span class="kn">import</span> <span class="n">nbscreenshot</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">ndisplay</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">canvas_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="edge-detection">
<h2>Edge detection<a class="headerlink" href="#edge-detection" title="Permalink to this heading">#</a></h2>
<p>We saw the <a class="reference external" href="https://en.wikipedia.org/wiki/Sobel_operator">Sobel operator</a> in the filters lesson. It is an edge detection algorithm that approximates the gradient of the image intensity, and is fast to compute. The <a class="reference external" href="https://scikit-image.org/docs/dev/api/skimage.filters.html#skimage.filters.scharr">Scharr filter</a> is a slightly more sophisticated version, with smoothing weights [3, 10, 3]. Finally, the Farid &amp; Simoncelli filter has <a class="reference external" href="https://en.wikipedia.org/wiki/Image_derivative#Farid_and_Simoncelli_Derivatives">even more sophisticated weights</a>. All three work for n-dimensional images in scikit-image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># grab individual channels and convert to float in [0, 1]</span>

<span class="n">membranes</span> <span class="o">=</span> <span class="n">cells3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cells3d</span><span class="p">)</span>
<span class="n">nuclei</span> <span class="o">=</span> <span class="n">cells3d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cells3d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">filters</span>


<span class="n">edges</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">farid</span><span class="p">(</span><span class="n">nuclei</span><span class="p">)</span>

<span class="n">edges_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">edges</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">blending</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input tag_remove-input docutils container">
</div>
</section>
<section id="thresholding">
<h2>Thresholding<a class="headerlink" href="#thresholding" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Thresholding_%28image_processing%29">Thresholding</a> is used to create binary images. A threshold value determines the intensity value separating foreground pixels from background pixels. Foregound pixels are pixels brighter than the threshold value, background pixels are darker. In many cases, images can be adequately segmented by thresholding followed by labelling of <em>connected components</em>, which is a fancy way of saying ‚Äúgroups of pixels that touch each other‚Äù.</p>
<p>Different thresholding algorithms produce different results. <a class="reference external" href="https://en.wikipedia.org/wiki/Otsu%27s_method">Otsu‚Äôs method</a> and <a class="reference external" href="https://scikit-image.org/docs/dev/auto_examples/developers/plot_threshold_li.html">Li‚Äôs minimum cross entropy threshold</a> are two common algorithms. Below, we use Li. You can use <code class="docutils literal notranslate"><span class="pre">skimage.filters.threshold_&lt;TAB&gt;</span></code> to find different thresholding methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">denoised</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">nuclei</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">li_thresholded</span> <span class="o">=</span> <span class="n">denoised</span> <span class="o">&gt;</span> <span class="n">filters</span><span class="o">.</span><span class="n">threshold_li</span><span class="p">(</span><span class="n">denoised</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">threshold_layer</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">li_thresholded</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We can see that the thresholded value is full of small holes, because of variation in pixel intensity inside the nuclei. Before proceeding further, we‚Äôd like to clean up those holes. Additionally, because of variations in the <em>background</em> intensity, some spurious small clumps of background pixels appear as foreground.</p>
</section>
<section id="morphological-operations">
<h2>Morphological operations<a class="headerlink" href="#morphological-operations" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Mathematical_morphology">Mathematical morphology</a> operations and structuring elements are defined in <code class="docutils literal notranslate"><span class="pre">skimage.morphology</span></code>. Structuring elements are shapes which define areas over which an operation is applied. The response to the filter indicates how well the neighborhood corresponds to the structuring element‚Äôs shape.</p>
<p>There are a number of two and three dimensional structuring elements defined in <code class="docutils literal notranslate"><span class="pre">skimage.morphology</span></code>. Not all 2D structuring element have a 3D counterpart. The simplest and most commonly used structuring elements are the <code class="docutils literal notranslate"><span class="pre">disk</span></code>/<code class="docutils literal notranslate"><span class="pre">ball</span></code> and <code class="docutils literal notranslate"><span class="pre">square</span></code>/<code class="docutils literal notranslate"><span class="pre">cube</span></code>.</p>
<p>Functions operating on <a class="reference external" href="https://en.wikipedia.org/wiki/Connected_space">connected components</a> can remove small undesired elements while preserving larger shapes.</p>
<p><code class="docutils literal notranslate"><span class="pre">skimage.morphology.remove_small_holes</span></code> fills holes and <code class="docutils literal notranslate"><span class="pre">skimage.morphology.remove_small_objects</span></code> removes bright regions. Both functions accept a size parameter, which is the minimum size (in pixels) of accepted holes or objects. It‚Äôs useful in 3D to think in linear dimensions, then cube them. In this case, we remove holes / objects of the same size as a cube 20 pixels across.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">morphology</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">remove_holes</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_holes</span><span class="p">(</span>
    <span class="n">li_thresholded</span><span class="p">,</span> <span class="n">width</span> <span class="o">**</span> <span class="mi">3</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">remove_objects</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">remove_small_objects</span><span class="p">(</span>
    <span class="n">remove_holes</span><span class="p">,</span> <span class="n">width</span> <span class="o">**</span> <span class="mi">3</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
    <span class="n">remove_objects</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cleaned&#39;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;li_thresholded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id1">
<h2>Segmentation<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h2>
<p>Now we are ready to label the connected components of this image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">remove_objects</span><span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We can see that tightly packed cells connected in the binary image are assigned the same label.</p>
<p>A better segmentation would assign different labels to different nuclei.</p>
<p>Typically we use <a class="reference external" href="https://en.wikipedia.org/wiki/Watershed_%28image_processing%29">watershed segmentation</a> for this purpose. We place <em>markers</em> at the center of each object, and these labels are expanded until they meet an edge or an adjacent marker.</p>
<p>The trick, then, is how to find these markers.</p>
<p>A common approach, which we saw above with the two overlapping circles, is to compute the distance transform of a binary mask, and place markers at the local maxima of that transform.</p>
<p>As you will see below, it can be quite challenging to find markers with the right location. A slight amount of noise in the image can result in very wrong point locations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">transformed</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span>
    <span class="n">remove_objects</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="n">spacing</span>
<span class="p">)</span>

<span class="n">maxima</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">local_maxima</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">maxima</span><span class="p">)),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bad points&#39;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">n_dimensional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># points have 3D &quot;extent&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nbscreenshot</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>You can see that these points are actually terrible, with many markers found within each nuclei.</p>
<section id="exercise-1-improve-the-points">
<h3>Exercise 1: improve the points<a class="headerlink" href="#exercise-1-improve-the-points" title="Permalink to this heading">#</a></h3>
<p>Try to improve the segmentation to assign one point for each nucleus. Some ideas:</p>
<ul class="simple">
<li><p>use a smoothed version of the nuclei image directly</p></li>
<li><p>smooth the distance map</p></li>
<li><p>use morphological operations to smooth the surface of the nuclei to ensure that they are close to spherical</p></li>
<li><p>use peak_local_max with <code class="docutils literal notranslate"><span class="pre">min_distance</span></code> parameter instead of <code class="docutils literal notranslate"><span class="pre">morphology.local_maxima</span></code></p></li>
<li><p>find points on a single plane, then prepend the plane index to the found coordinates</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution here</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mixing-manual-annotation-and-algorithms">
<h3>Mixing manual annotation and algorithms<a class="headerlink" href="#mixing-manual-annotation-and-algorithms" title="Permalink to this heading">#</a></h3>
<p>As you will have seen from the previous exercise, there are many approaches to find better seed points, but they are often fiddly and tedious, and sensitive to parameters ‚Äî when you encounter a new image, you might have to start all over again!</p>
<p>With napari, in many cases, a little interactivity, combined with the segmentation algorithms in scikit-image and elsewhere, can quickly get us the segmentation we want.</p>
<p>Below, you can use full manual annotation, or light editing of the points you found automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;bad points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">ndisplay</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">set_point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">points</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interactive points&#39;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">ndim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">n_dimensional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">points</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>


<span class="c1"># now, we annotate the centers of the nuclei in your image</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p>Once you have marked all the points, you can grab the data back, and make a markers image for <code class="docutils literal notranslate"><span class="pre">skimage.segmentation.watershed</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">segmentation</span><span class="p">,</span> <span class="n">util</span>

<span class="n">marker_locations</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">data</span>


<span class="n">markers</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">label_points</span><span class="p">(</span><span class="n">marker_locations</span><span class="p">,</span> <span class="n">nuclei</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">markers_big</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">dilation</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="n">morphology</span><span class="o">.</span><span class="n">ball</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">segmented</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">watershed</span><span class="p">(</span>
    <span class="n">edges</span><span class="p">,</span>
    <span class="n">markers_big</span><span class="p">,</span>
    <span class="n">mask</span><span class="o">=</span><span class="n">remove_objects</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">final_segmentation</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span>
    <span class="n">segmented</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
    <span class="n">blending</span><span class="o">=</span><span class="s1">&#39;translucent_no_depth&#39;</span><span class="p">,</span>  <span class="c1"># don&#39;t hide enclosed points</span>
<span class="p">)</span>

<span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p>After watershed, we have better disambiguation between internal cells!</p>
</section>
</section>
<section id="making-measurements">
<h2>Making measurements<a class="headerlink" href="#making-measurements" title="Permalink to this heading">#</a></h2>
<p>Once we have defined our objects, we can make measurements on them using <code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> and <code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops_table</span></code>. These measurements include features such as area or volume, bounding boxes, and intensity statistics.</p>
<p>Before measuring objects, it helps to clear objects from the image border. Measurements should only be collected for objects entirely contained in the image.</p>
<p>Given the layer-like structure of our data, we only want to clear the objects touching the sides of the volume, but not the top and bottom, so we pad and crop the volume along the 0th axis to avoid clearing the mitotic nucleus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">segmented_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
    <span class="n">segmented</span><span class="p">,</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
    <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">interior_labels</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">clear_border</span><span class="p">(</span><span class="n">segmented_padded</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> automatically measures many labeled image features. Optionally, an <code class="docutils literal notranslate"><span class="pre">intensity_image</span></code> can be supplied and intensity features are extracted per object. It‚Äôs good practice to make measurements on the original image.</p>
<p>Not all properties are supported for 3D data. Below we build a list of supported and unsupported 3D measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">regionprops</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">interior_labels</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">nuclei</span><span class="p">)</span>

<span class="n">supported</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="n">unsupported</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">regionprops</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">regionprops</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
        <span class="n">supported</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="n">unsupported</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D/nD properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D-only properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unsupported</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>scikit-image 0.18 adds support for <a class="reference external" href="https://scikit-image.org/docs/dev/api/skimage.measure.html#skimage.measure.regionprops">passing custom functions</a> for region properties as <code class="docutils literal notranslate"><span class="pre">extra_properties</span></code>. After this tutorial, you might want to try it out to <a class="reference external" href="https://github.com/scikit-image/scikit-image/issues/3797#issuecomment-471277056">determine the surface area</a> of the nuclei or cells!</p>
<p><code class="docutils literal notranslate"><span class="pre">skimage.measure.regionprops</span></code> ignores the 0 label, which represents the background.</p>
<p><code class="docutils literal notranslate"><span class="pre">regionprops_table</span></code> returns a dictionary of columns compatible with creating a pandas dataframe of properties of the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="n">info_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span>
        <span class="n">interior_labels</span><span class="p">,</span>
        <span class="n">intensity_image</span><span class="o">=</span><span class="n">nuclei</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;solidity&#39;</span><span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">info_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use pandas and seaborn for some analysis!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;solidity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">info_table</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;mean_intensity&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that the mitotic nucleus is a clear outlier from the others in terms of solidity and intensity.</p>
<section id="exercise-2-physical-measurements">
<h3>Exercise 2: physical measurements<a class="headerlink" href="#exercise-2-physical-measurements" title="Permalink to this heading">#</a></h3>
<p>The ‚Äúarea‚Äù property above is actually the volume of the region, measured in voxels. Add a new column to your dataframe, <code class="docutils literal notranslate"><span class="pre">'area_um3'</span></code>, containing the volume in ¬µm¬≥. <em>Hint: remember the voxel spacing we noted at the start of the tutorial. You only need pandas to do this.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution here</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-3-displaying-regionprops-or-other-values">
<h3>Exercise 3: displaying regionprops (or other values)<a class="headerlink" href="#exercise-3-displaying-regionprops-or-other-values" title="Permalink to this heading">#</a></h3>
<p>Now that you have segmented cells, (or even with just the nuclei), use <a class="reference external" href="https://scikit-image.org/docs/dev/api/skimage.util.html#skimage.util.map_array"><code class="docutils literal notranslate"><span class="pre">skimage.util.map_array</span></code></a> to display a volume of the value of a regionprop (say, ‚Äòsolidity‚Äô of the cells) on top of the segments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution here</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./day2"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#separating-an-image-into-one-or-more-regions-of-interest">Separating an image into one or more regions of interest.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-napari-viewer">The napari viewer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-0-play-with-the-napari-viewer">Exercise 0: play with the napari viewer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmenting-nuclei-and-measuring-cell-properties">Segmenting nuclei and measuring cell properties</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection">Edge detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thresholding">Thresholding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#morphological-operations">Morphological operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-improve-the-points">Exercise 1: improve the points</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mixing-manual-annotation-and-algorithms">Mixing manual annotation and algorithms</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-measurements">Making measurements</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-physical-measurements">Exercise 2: physical measurements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-displaying-regionprops-or-other-values">Exercise 3: displaying regionprops (or other values)</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Marcelo Leomil Zoccoler, Juan Nunez-Iglesias, Juli√°n Mej√≠a, Adan O. Guerrero Cardenas, Tobias Wenzel
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      ¬© Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>